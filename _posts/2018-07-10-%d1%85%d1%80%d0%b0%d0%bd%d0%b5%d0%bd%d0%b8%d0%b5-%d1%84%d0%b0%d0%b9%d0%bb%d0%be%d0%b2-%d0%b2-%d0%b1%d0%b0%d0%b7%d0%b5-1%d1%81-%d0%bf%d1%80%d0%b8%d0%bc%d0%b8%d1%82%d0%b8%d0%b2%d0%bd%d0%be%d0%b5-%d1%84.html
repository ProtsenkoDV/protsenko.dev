---
layout: post
status: publish
published: true
title: Хранение файлов в базе 1С. Примитивное файловое хранилище на Base64
author:
  display_name: Dima Protsenko
  login: Dima Protsenko
  email: ''
  url: ''
author_login: Dima Protsenko
wordpress_id: 9
date: '2018-07-10 10:25:00 +0500'
date_gmt: '2018-07-10 07:25:00 +0500'
---
<div dir="ltr" style="text-align: left;">
<div>
<div>Добрый день, это гайд <span style="text-decoration: line-through;">из нескольких частей</span> о том как можно удобно хранить файлы в самописной базе, а  также их открывать.<br />
Для того чтобы хранить файлы в базе данных, необходимо:<br />
1. Создать справочник, с реквизитом файл, тип строка, длина - неограниченная, длина наименования 125<br />
2. Описать процедуру загрузки файла</p>
<p>Файлы необходимо хранить в виде строки, алгоритм прост:<br />
1. Запускаем диалоговое окно для выбора файла<br />
2. Конвертируем выбранный файл в двоичные данные<br />
3. Конвертируем в Base64, и сохраняем в справочнике<br />
<a name="more"></a>Соответственно чтобы открыть файлы, алгоритм будет обратный:<br />
1. Base64 конвертируем в двоичные данные<br />
2. Записываем на диск (будем использовать временную папку системы)<br />
3. Открываем через ЗапуститьПриложение()</p>
<p>Начнем:</p>
<h3 style="text-align: center;">Загрузка файлов</h3>
<p>Подразумеваю что первоначальная инструкция выполнена, перейдем дальше:</p>
<ul style="text-align: left;">
<li>Создаем форму элемента, добавляем команду ЗагрузитьФайл</li>
<li>К ней цепляем процедуру которая будет выполняться на <b><u>клиенте</u></b></li>
<li>Команду кидаем на форму</li>
<li>В модуле формы создаем функцию запуска диалога выбора файла:</li>
</ul>
</div>
<blockquote><p>&amp;НаКлиенте<br />
Функция ВыбратьФайл()<br />
ДиалогОткрытияФайла = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);<br />
ДиалогОткрытияФайла.ПроверятьСуществованиеФайла = Истина;<br />
ДиалогОткрытияФайла.МножественныйВыбор = Ложь;<br />
ДиалогОткрытияФайла.Заголовок = "Выберите файл для загрузки";<br />
Если ДиалогОткрытияФайла.Выбрать() Тогда<br />
Возврат ДиалогОткрытияФайла.ПолноеИмяФайла;<br />
Иначе<br />
Возврат ЛОЖЬ;<br />
КонецЕсли;<br />
КонецФункции</p></blockquote>
<ul style="text-align: left;">
<li> У процедуры ЗагрузитьФайл вызываем данную функцию, с записью в переменную ПутьКФайлу</li>
<li>Стоит конечно же сделать проверку на факт того что файл был выбран</li>
<li>Далее преобразуем выбранный файл в двоичные данные,  и с помощью Base64Строка() переводим в Base64</li>
<li>Объекту Файл присваиваем данное значение</li>
<li>Теперь необходимо указать наименование, мы имеем полный путь к файлу, а нам нужен с расширением файла, для этого объявляем Новый Файл(ПутьКФайлу), в наименование пишем поле <u>Имя</u> данного файла.</li>
<li>Получится такая вот процедура:</li>
</ul>
<blockquote><p> &amp;НаКлиенте<br />
Процедура ЗагрузитьФайл(Команда)<br />
ПутьКФайлу = ВыбратьФайл();<br />
Если ПутьКФайлу&lt;&gt;ЛОЖЬ Тогда<br />
БинарныйФайл = Новый ДвоичныеДанные(ПутьКФайлу);<br />
Base64 = Base64Строка(БинарныйФайл);<br />
Объект.Файл = Base64;<br />
ФайлДляНаименования = Новый Файл(ПутьКФайлу);<br />
Объект.Наименование = ФайлДляНаименования.Имя;<br />
Иначе<br />
Сообщить("Файл не выбран");<br />
КонецЕсли;<br />
КонецПроцедуры</p></blockquote>
<h3 style="text-align: center;"> Открытие файлов</h3>
<ul style="text-align: left;">
<li> Проверим заполнено ли значение файла</li>
<li>Для записи файла на диск из Base64 нам необходим новый полный путь к файлу, строим его относительно папки Temp, для этого вызываем функцию КаталогВременныхФайлов(), и крепим к нему наименование элемента справочника (в предыдущем разделе мы специальной сохраняли имя файла с расширением)</li>
<li>В переменную БинарныйФайл пишем двоичные данные из Base64, т.е. расшифровываем нашу строку с помощью Base64Значение()</li>
<li>Производим запись, и запуск файла с помощью ЗапуститьПриложение()</li>
</ul>
<blockquote><p>&amp;НаКлиенте<br />
Процедура ОткрытьФайл(Команда)<br />
Если ЗначениеЗаполнено(Объект.Файл) Тогда<br />
ПутьКФайлу = КаталогВременныхФайлов()+Объект.Наименование;<br />
БинарныйФайл = Base64Значение(Объект.Файл);<br />
БинарныйФайл.Записать(ПутьКФайлу);<br />
ЗапуститьПриложение(ПутьКФайлу);<br />
Иначе<br />
Сообщить("Файл не загружен");<br />
КонецЕсли;<br />
КонецПроцедуры</p></blockquote>
<p>Так-же не забудьте навести красоту на форме.<br />
Недостатки на данном этапе:</p>
<ul style="text-align: left;">
<li>Можно загружать один и тот же файл сколько угодно раз</li>
<li>Временные файлы не удаляются</li>
<li>Файлы хранятся не в архиве, и занимают больше места</li>
</ul>
<p><a href="https://github.com/ProtsenkoDV/thesilverwolf/blob/master/1C/primitive%20file%20base.dt" target="_blank" rel="nofollow noopener noreferrer">Скачать конфигурацию </a></p>
</div>
</div>
